class Distribucion{constructor(id,orden,fecha,idUsuario,idBodega,porcentajeDescuento,porcentajeIva,lista,bodega,fechaInicial,fechaFinal){this.id=id||null,this.orden=orden||"",this.fecha=fecha||"",this.idUsuario=idUsuario||null,this.idBodega=idBodega||null,this.bodega=bodega||null,this.porcentajeDescuento=porcentajeDescuento||0,this.porcentajeIva=porcentajeIva||0,this.lista=lista||[],this.fechaInicial=fechaInicial||"",this.fechaFinal=fechaFinal||""}get tUpdate(){return this.update="update"}get tSelect(){return this.select="select"}set viewEventHandler(_t){this.viewType=_t}get Read(){NProgress.start();var miAccion=null==this.id?"ReadAll":"Read";"ReadAll"==miAccion&&0==$("#tDistribucion tbody").length||$.ajax({type:"POST",url:"class/Distribucion.php",data:{action:miAccion,id:this.id}}).done(function(e){distr.Reload(e)}).fail(function(e){distr.showError(e)}).always(NProgress.done())}get Save(){if(0!=$("#tDistribucion tbody tr").length){$("#btnDistribucion").attr("disabled","disabled");var miAccion=null==distr.id?"Create":"Update";distr.totalVenta=0,distr.totalDescuentos=0,distr.totalVentaneta=0,distr.totalImpuesto=0,distr.totalComprobante=0,distr.lista=[],$("#tDistribucion tbody tr").each(function(i,item){var objlista=new Object;objlista.idProducto=$(item).find("td:eq(0)")[0].textContent,objlista.codigo=$(this).find("td:eq(1)").html(),objlista.valor=$(item).find("td:eq(6)").attr("value"),objlista.cantidad=parseFloat($(item).find("td:eq(5) input").val()),objlista.detalle=objlista.codigo,objlista.precioUnitario=parseFloat(parseFloat(objlista.valor).toFixed(5)),objlista.numeroLinea=i+1,objlista.idTipoCodigo=1,objlista.codigo=objlista.codigo,objlista.idUnidadMedida=78,objlista.montoTotal=parseFloat((objlista.precioUnitario*objlista.cantidad).toFixed(5)),objlista.montoDescuento=0,objlista.naturalezaDescuento="No aplican descuentos",objlista.subTotal=parseFloat((objlista.montoTotal-objlista.montoDescuento).toFixed(5)),objlista.codigoImpuesto=1,objlista.tarifaImpuesto=13,objlista.montoImpuesto=parseFloat((objlista.subTotal*(objlista.tarifaImpuesto/100)).toFixed(5)),objlista.montoTotalLinea=parseFloat((objlista.subTotal+objlista.montoImpuesto).toFixed(5)),distr.totalVenta=parseFloat((distr.totalVenta+objlista.montoTotal).toFixed(5)),distr.totalDescuentos=parseFloat((distr.totalDescuentos+objlista.montoDescuento).toFixed(5)),distr.totalImpuesto=parseFloat((distr.totalImpuesto+objlista.montoImpuesto).toFixed(5)),distr.lista.push(objlista)}),distr.totalServGravados=0,distr.totalServExentos=0,distr.totalMercanciasGravadas=distr.totalVenta,distr.totalMercanciasExentas=0,distr.totalGravado=parseFloat((distr.totalServGravados+distr.totalMercanciasGravadas).toFixed(5)),distr.totalExento=parseFloat((distr.totalServExentos+distr.totalMercanciasExentas).toFixed(5)),distr.totalVenta=parseFloat((distr.totalGravado+distr.totalExento).toFixed(5)),distr.totalVentaneta=parseFloat((distr.totalVenta-distr.totalDescuentos).toFixed(5)),distr.totalComprobante=parseFloat((distr.totalVentaneta+distr.totalImpuesto).toFixed(5)),distr.idReceptor=bodega.id,distr.orden=$("#orden").val(),distr.idBodega=bodega.id,distr.porcentajeDescuento=$("#desc_100").val(),distr.porcentajeIva=$("#iv_100").val(),$.ajax({type:"POST",url:"class/Distribucion.php",data:{action:miAccion,obj:JSON.stringify(this)}}).done(function(e){"NORECEPTOR"==JSON.parse(e)?swal({type:"warning",title:"Receptor",text:"Receptor no registrado para Facturación Electrónica",allowOutsideClick:!1}):"NOCONTRIB"==JSON.parse(e)?swal({type:"warning",title:"Contibuyente",text:"Emisor no registrado para Facturación Electrónica",allowOutsideClick:!1}):distr.ticketPrint(e)}).fail(function(e){distr.showError(e)}).always(function(){$("#btnDistribucion").removeAttr("disabled"),(distr=new Distribucion).CleanCtls(),$("#p_searh").focus()})}else swal({type:"warning",title:"Orden de Traslado",text:"Debe agregar items a la lista",showConfirmButton:!1,timer:3e3})}ticketPrint(e){"Interna"==bodega.tipo?localStorage.setItem("lsTipoBodega","interna"):localStorage.setItem("lsTipoBodega","externa");var data=JSON.parse(e);localStorage.setItem("lsRePrint",!1),localStorage.setItem("lsOrden",data.orden),localStorage.setItem("lsBodega",$("#nombre").val()),localStorage.setItem("lsDescripcion",$("#descripcion").val()),localStorage.setItem("lsSubTotal",$("#subtotal").text()),localStorage.setItem("lsTotal",$("#total").text()),localStorage.setItem("lsFechaDistribucion",data.fecha),localStorage.setItem("lsPorcentajeDescuento",$("#desc_val").text()),localStorage.setItem("lsIV",$("#iv_val").text()),localStorage.setItem("lsListaProducto",JSON.stringify(data.lista)),localStorage.setItem("lsUsuarioDistribucion",$("#call_name").text()),location.href="/TicketDistribucion.html"}ticketRePrint(){var listaProducto=[],subtotal=0,iv=0;"Externa"==bodega.tipo?localStorage.setItem("lsTipoBodega","externa"):localStorage.setItem("lsTipoBodega","interna"),$("#tb_detalle_distribucion tbody tr").each(function(){var lsListaProducto=new Object;lsListaProducto.cantidad=$(this).find("td:eq(2)").html(),lsListaProducto.codigo=$(this).find("td:eq(0)").html(),lsListaProducto.precioVenta=parseFloat($(this).find("td:eq(3)").html().replace("¢","").replace(",",""))*lsListaProducto.cantidad,lsListaProducto.precioVenta="¢"+parseFloat(lsListaProducto.precioVenta).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),subtotal+=parseFloat($(this).find("td:eq(3)").html().replace("¢","").replace(",",""))*lsListaProducto.cantidad,listaProducto.push(lsListaProducto)}),localStorage.setItem("lsListaProducto",JSON.stringify(listaProducto)),localStorage.setItem("lsRePrint",!0),localStorage.setItem("lsSubTotal","¢"+parseFloat(subtotal).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")),localStorage.setItem("lsIV","¢"+parseFloat(.13*subtotal).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")),localStorage.setItem("lsTotal",$("#total").text()),localStorage.setItem("lsFechaDistribucion",$("#fechaDistribucion").text()),localStorage.setItem("lsBodega",$("#bodega").text()),localStorage.setItem("lsOrden",$("#consecutivo").text()),localStorage.setItem("lsUsuarioDistribucion",$("#call_name").html()),location.href="/TicketDistribucion.html"}get ReadbyOrden(){$("#orden").attr("disabled","disabled");var miAccion="ReadbyOrden";distr.orden=$("#p_searh").val(),$.ajax({type:"POST",url:"class/Distribucion.php",data:{action:miAccion,obj:JSON.stringify(this)}}).done(function(e){"null"==e||""==e?swal({type:"warning",title:"Orden no encontrada!",title:"La Orden no existe o no se encuentra disponible para esta bodega.",showConfirmButton:!1,timer:3e3}):distr.ShowOrderData(e)}).fail(function(e){distr.showError(e)}).always(function(){$("#orden").removeAttr("disabled")})}Aceptar(){$("#btnDistribucion").attr("disabled","disabled");var miAccion="Aceptar";distr.lista=[],$("#tDistribucion tbody tr").each(function(i,item){var objlista=new Object;objlista.idProducto=$(item).find("td:eq(0)")[0].textContent,objlista.cantidad=$(item).find("td:eq(5) input").val(),objlista.costo=$(item).find("td:eq(6)").attr("value"),objlista.valor=parseFloat(parseInt(objlista.cantidad)*parseFloat(objlista.costo)),distr.lista.push(objlista)}),$.ajax({type:"POST",url:"class/Distribucion.php",data:{action:miAccion,obj:JSON.stringify(this)}}).done(distr.showInfo).fail(function(e){distr.showError(e)}).always(function(){$("#btnDistribucion").removeAttr("disabled"),(distr=new Distribucion).CleanCtls(),$("#p_searh").focus()})}Reload(e){null==this.id?this.ShowAll(e):this.ShowItemData(e)}ShowAll(e){var t=$("#tDistribucion").DataTable();t.clear(),t.rows.add(JSON.parse(e)),t.order([1,"desc"]).draw()}ShowOrderData(e){this.CleanCtls();var data=JSON.parse(e);distr=new Distribucion(data.id,data.orden,data.fecha,data.idUsuario,data.idBodega,data.porcentajeDescuento,data.porcentajeIva,data.lista),$("#orden").val(distr.orden),$("#fecha").val(distr.fecha),bodega.id=distr.idBodega,bodega.Read,$.each(distr.lista,function(i,item){producto=item,distr.AgregaProducto()})}ShowItemData(e){var data=JSON.parse(e);(distr=new Distribucion(data.id,data.orden,data.fecha,data.idUsuario,data.idBodega,data.porcentajeDescuento,data.porcentajeIva,data.lista,data.bodega)).total=data.total,$("#detalleDistribucion").empty();var detalleDistribucion=`<button type="button" class="close" data-dismiss="modal">\n                <span aria-hidden="true">X</span>\n            </button>\n            <h4 class="modal-title" id="myModalLabel">Traslado #<label id=consecutivo>${distr.orden}</label></h4>\n            <div class="row">\n                \n                <div class="col-md-6 col-sm-6 col-xs-6">\n                    <p>Fecha: <label id=fechaDistribucion>${distr.fecha}</label></p>\n                </div>\n            </div>\n            <div class="row">                \n                <div class="col-md-6 col-sm-6 col-xs-6">\n                    <p>Destino: <label id=bodega>${distr.bodega}</label></p>\n                </div>\n            </div>\n            <div class="row">                \n                <div class="col-md-6 col-sm-6 col-xs-6">\n                    <p>TOTAL: <label id=total>${"¢"+parseFloat(distr.total).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,".")}</label></p>\n                </div>\n            </div>`;$("#detalleDistribucion").append(detalleDistribucion),$("#totalDistribucion").empty(),this.tb_prdXFact=$("#tb_detalle_distribucion").DataTable({data:distr.lista,destroy:!0,searching:!1,paging:!1,info:!1,ordering:!1,order:[[0,"desc"]],columns:[{title:"CODIGO",data:"codigo"},{title:"NOMBRE",data:"nombre"},{title:"CANTIDAD",data:"cantidad"},{title:"PRECIO VENTA",data:"precioVenta",className:"text-right",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"IV",data:"impuesto",className:"text-right",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"SUBTOTAL",data:"subtotal",className:"text-right",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}}]}),$("#modalDistribucion").modal("toggle")}showInfo(){$(".close").click(),swal({type:"success",title:"Listo!",showConfirmButton:!1,timer:1e3})}showError(e){var data=JSON.parse(e.responseText);swal({type:"error",title:"Oops...",text:"Algo no está bien ("+data.code+"): "+data.msg,footer:"<a href>Contacte a Soporte Técnico</a>"})}CleanCtls(){var t;$("#p_searh").val(""),$("#proveedor").val(""),$("#orden").val(""),$("#tDistribucion").DataTable().rows().remove().draw(),$("#subtotal")[0].textContent="¢0",$("#desc_val")[0].textContent="¢0",$("#iv_val")[0].textContent="¢0",$("#total")[0].textContent="¢0",$("#nombre").val(""),$("#descripcion").val("")}ResetSearch(){$("#p_searh").val("")}LoadProducto(){""!=$("#p_searh").val()&&(NProgress.start(),$("#p_searh").attr("disabled","disabled"),producto.codigo=$("#p_searh").val(),$.ajax({type:"POST",url:"class/Producto.php",data:{action:"ReadByCode",obj:JSON.stringify(producto)}}).done(function(e){distr.ResetSearch(),distr.ValidateProductoFac(e)}).fail(function(e){distr.showError(e)}).always(function(){$("#p_searh").removeAttr("disabled"),$("#p_searh").focus(),NProgress.done()}))}ValidateProductoFac(e){if("false"!=e){producto=JSON.parse(e)[0];var tableRow=$("#tDistribucion tbody tr td").filter(function(){return $(this).text()==producto.id}).length;producto.saldoCantidad<=0?swal({type:"warning",title:"Determinación de Producto",text:"El producto No tiene Saldo.",showConfirmButton:!1,timer:3e3}):0==tableRow?distr.AgregaProducto():swal({type:"warning",title:"El producto "+producto.codigo+" ya está en la lista.",showConfirmButton:!1,timer:3e3})}else swal({type:"warning",title:"El producto "+producto.codigo+" NO existe.",showConfirmButton:!1,timer:3e3})}AgregaProducto(){var t=$("#tDistribucion").DataTable(),rowNode=t.row.add(producto).draw().node();$("td:eq(4)",rowNode).attr({id:"saldoCantidad"+producto.id,value:producto.saldoCantidad,align:"right"})[0].textContent=parseFloat(producto.saldoCantidad).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),$("td:eq(5) input",rowNode).attr({id:"cantidad"+producto.id,max:producto.saldoCantidad,min:"1",step:"1",value:producto.cantidad||1}).on("keyup keypress mouseup",function(e){var keyCode;if(109==(e.keyCode||e.which))return e.preventDefault(),!1;distr.setProducto($(this).parents("tr").find("td:eq(0)").html()),producto.saldoCantidad<producto.cantidad&&(swal({type:"warning",title:"Saldo Insuficiente",text:"El producto contiene unicamente "+producto.saldoCantidad+" unidades",showConfirmButton:!1,timer:3e3}),$(this).val(producto.saldoCantidad),distr.setProducto($(this).parents("tr").find("td:eq(0)").html())),distr.CalcImporte()}),$("td:eq(6)",rowNode).attr({id:"precioVenta"+producto.id,value:producto.precioVenta/1.13,align:"right"})[0].textContent="¢"+parseFloat(producto.precioVenta/1.13).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),$("td:eq(7)",rowNode).attr({id:"subtotal"+producto.id,value:0,align:"right"})[0].textContent=0,t.columns.adjust().draw(),distr.setProducto(producto.id),distr.CalcImporte()}UpdateEventHandler(){distr.id=$(this).parents("tr").find(".itemId").text()||$(this).find(".itemId").text(),"Externa"==$(this).parents("tr").find("td:eq(7)").text()?bodega.tipo="Externa":bodega.tipo="Interna",distr.Read}DeleteEventHandler(btn){var t;$("#tDistribucion").DataTable().row($(btn).parents("tr")).remove().draw(),distr.setProducto($(btn).parents("tr").find("td:eq(0)").html()),distr.calcTotal()}DeleteDistr(e){distr.estado=$(e).parents("tr").find("td:eq(6)").text(),"LIQUIDADO"!=distr.estado?swal({type:"warning",title:"Distribución",text:"No es posible Eliminar una orden de Distribución sin ACEPTAR o CANCELADA.",allowOutsideClick:!1}):swal({title:"Eliminar?",text:"Esta acción es irreversible!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, cancelar!",confirmButtonClass:"btn btn-success",cancelButtonClass:"btn btn-danger"}).then(result=>{result.value&&(distr.id=$(e).parents("tr").find(".itemId").text(),distr.orden=$(e).parents("tr").find("td:eq(2)").text(),$.ajax({type:"POST",url:"class/Distribucion.php",data:{action:"Delete",id:distr.id,orden:distr.orden}}).done(distr.showInfo).fail(function(e){distr.showError(e)}).always(function(){(distr=new Distribucion).CargaTrasladosRango()}))})}setProducto(idp){producto.id=idp,producto.saldoCantidad=parseFloat($(`#saldoCantidad${idp}`).attr("value")),producto.cantidad=$(`#cantidad${idp}`).val(),producto.precioVenta=parseFloat($(`#precioVenta${idp}`).attr("value")),producto.subtotal=(producto.cantidad*producto.precioVenta).toFixed(10)}CalcImporte(){$(`#subtotal${producto.id}`).attr({value:producto.subtotal}),$(`#subtotal${producto.id}`)[0].textContent="¢"+parseFloat(producto.subtotal).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),distr.calcTotal()}calcTotal(){var subtotal=0;distr.porcentajeDescuento=0,distr.porcentajeIva=13,$("#desc_100").val(distr.porcentajeDescuento),$("#iv_100").val(distr.porcentajeIva),$("#subtotal")[0].textContent="¢0",$("#desc_val")[0].textContent="¢0",$("#iv_val")[0].textContent="¢0",$("#total")[0].textContent="¢0",$("#tDistribucion tr").find("td:eq(7)").each(function(i,item){subtotal+=parseFloat($(item).attr("value"))}),subtotal>0&&($("#subtotal")[0].textContent="¢"+parseFloat(subtotal).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),distr.descuento=subtotal*(parseFloat(distr.porcentajeDescuento)/100),$("#desc_val")[0].textContent="¢"+parseFloat(distr.descuento).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),distr.iva=subtotal*(parseFloat(distr.porcentajeIva)/100),$("#iv_val")[0].textContent="¢"+parseFloat(distr.iva).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),distr.total=subtotal-distr.descuento+distr.iva,$("#total")[0].textContent="¢"+parseFloat(distr.total).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","))}setTable(buttons=!0,nPaging=10){$("#tDistribucion").DataTable({responsive:!0,info:!1,iDisplayLength:nPaging,paging:!1,language:{infoEmpty:"Sin Productos Ingresados",emptyTable:"Sin Productos Ingresados",search:"Buscar",zeroRecords:"No hay resultados",lengthMenu:"Mostrar _MENU_ registros",paginate:{first:"Primera",last:"Ultima",next:"Siguiente",previous:"Anterior"}},columnDefs:[{className:"text-center",targets:[4]}],columns:[{title:"ID",data:"id",className:"itemId",searchable:!1},{title:"CODIGO",data:"codigo"},{title:"NOMBRE",data:"nombre"},{title:"DESCRIPCION",data:"descripcion"},{title:"SALDO CANTIDAD",data:"saldoCantidad"},{title:"CANTIDAD",data:"cantidad",mRender:function(){return'<input class="cantidad form-control" type="number" min="1" max="9999999999" step="1" style="text-align:right;" >'}},{title:"PRECIO VENTA",data:"precioVenta"},{title:"SUBTOTAL",data:null},{title:"ACCION",orderable:!1,searchable:!1,visible:buttons,className:"buttons",width:"5%",mRender:function(){return'<a class="delete" onclick="distr.DeleteEventHandler(this)" style="cursor: pointer;"> <i class="glyphicon glyphicon-trash"> </i>  </a>'}}]})}setTableVista(buttons=!0){$("#tDistribucion").DataTable({responsive:!0,destroy:!0,order:[[1,"desc"]],dom:"Bfrtip",buttons:[{extend:"excelHtml5",exportOptions:{columns:[1,2,3,4,5,6]},messageTop:"Traslados y facturación"},{extend:"pdfHtml5",messageTop:"Traslados y facturación",exportOptions:{columns:[1,2,3,4,5,6]}}],language:{infoEmpty:"Sin Traslados Registrados",emptyTable:"Sin Traslados Registrados",search:"Buscar",zeroRecords:"No hay resultados",lengthMenu:"Mostrar _MENU_ registros",paginate:{first:"Primera",last:"Ultima",next:"Siguiente",previous:"Anterior"}},columns:[{title:"ID",data:"id",className:"itemId",searchable:!1},{title:"FECHA",data:"fecha"},{title:"ORDEN",data:"orden"},{title:"USUARIO",data:"userName"},{title:"BODEGA",data:"bodega"},{title:"TOTAL",data:"total",className:"text-right",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,".")}},{title:"ESTADO",data:"idEstadoComprobante",render:function(data,type,row,meta){if("Interna"==row.tipoBodega)return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green"> Interna</i>';switch(data){case"1":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:red"> Sin Enviar</i>';case"2":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:green"> Enviado</i>';case"3":return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green"> Aceptado</i>';case"4":return'<i class="fa fa-times-circle" aria-hidden="true" style="color:red"> Rechazado</i>';case"5":return'<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color:#FF6F00"> Otro</i>';case"99":return'<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color:green"> Reportado</i>';default:return"Desconocido"}}},{title:"TIPO BODEGA",data:"tipoBodega"},{title:"ACCION",className:"buttons",data:"claveNC",render:function(data,type,row,meta){if("Interna"==row.tipoBodega)return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green"> Interna</i>';if(null!=data)return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green">Factura Cancelada!</i>';switch(row.idEstadoComprobante){case"1":return"<button class=btnEnviarFactura>Enviar</button>";case"2":return"<button class=btnConsultafactura>Consultar</button>";case"3":case"4":return"<button class=btnCancelaFactura>Cancelar Factura</button>";case"5":return"<button class=btnReenviarFactura>Reenviar</button><button class=btnSoporte>Soporte</button>";default:return"<button>Soporte</button>"}}}]})}CargaTrasladosRango(){$.ajax({type:"POST",url:"class/Distribucion.php",data:{action:"ReadAllbyRange",obj:JSON.stringify(distr)}}).done(function(e){distr.ShowAll(e)})}}let distr=new Distribucion;