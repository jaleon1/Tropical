class InventarioFacturas{constructor(facturas,tb_facturas,tb_facturasExternas,factDetalle,tb_prdXFact,fechaInicial,fechaFinal,respuesta){this.facturas=facturas||new Array,this.factDetalle=factDetalle||new Array,this.tb_facturas=tb_facturas||null,this.tb_facturasExternas=tb_facturasExternas||null,this.fechaInicial=fechaInicial||"",this.fechaFinal=fechaFinal||"",this.respuesta=respuesta||""}CargaFacturas(){$.ajax({beforeSend:function(){$("body").addClass("loading")},type:"POST",url:"class/Factura.php",data:{action:"ReadAllbyRange",obj:JSON.stringify(inventarioFacturas)},complete:function(){$("body").removeClass("loading")}}).done(function(e){inventarioFacturas.drawFac(e)})}CargaFacturasXUsuario(){$.ajax({type:"POST",url:"class/Factura.php",data:{action:"ReadAllById"}}).done(function(e){"NOCONTRIB"==JSON.parse(e).msg?swal({type:"warning",title:"Contribuyente",text:"Contribuyente no registrado para Facturación Electrónica",footer:'<a href="clienteFE.html">Agregar Contribuyente</a>'}).then(result=>{result.value&&(location.href="Dashboard.html")}):inventarioFacturas.drawFacUser(e)})}drawFac(e){var facturas=JSON.parse(e);this.tb_facturas=$("#tb_facturas").DataTable({responsive:!0,destroy:!0,dom:"Bfrtip",buttons:[{extend:"excelHtml5",footer:!0,exportOptions:{columns:[1,2,3,4,5,6]},messageTop:"Lista de facturas"},{extend:"pdfHtml5",footer:!0,messageTop:"Lista de facturas",exportOptions:{columns:[1,2,3,4,5,6]}}],language:{infoEmpty:"Sin Facturas Registradas",emptyTable:"Sin Facturas Registradas",search:"Buscar",zeroRecords:"No hay resultados",lengthMenu:"Mostrar _MENU_ registros",paginate:{first:"Primera",last:"Ultima",next:"Siguiente",previous:"Anterior"}},data:facturas,order:[[2,"desc"]],columns:[{title:"ID FACTURA",data:"id",visible:!1},{title:"#FACTURA",data:"consecutivo"},{title:"FECHA",data:"fechaCreacion"},{title:"ALMACEN",data:"bodega"},{title:"VENDEDOR",data:"vendedor"},{title:"TOTAL",data:"totalComprobante",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"MONTO EFECTIVO",data:"montoEfectivo",visible:!1,mRender:function(e){return null==e?"¢0":"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"MONTO TARJETA",data:"montoTarjeta",visible:!1,mRender:function(e){return null==e?"¢0":"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"ESTADO",data:"idEstadoComprobante",mRender:function(e){switch(e){case"1":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:red"> Sin Enviar</i>';case"2":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:green"> Enviado</i>';case"3":return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green"> Aceptado</i>';case"4":return'<i class="fa fa-times-circle" aria-hidden="true" style="color:red"> Rechazado</i>';case"5":return'<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color:#FF6F00"> Otro</i>';case"6":return'<i class="fa fa-stopwatch" aria-hidden="true" style="color:#FF6F00"> TimedOut</i>';case"7":return'<i class="fa fa-angle-double-up" aria-hidden="true" style="color:#FF6F00"> Repetido</i>';case"8":return'<i class="fa fa-minus-circle" aria-hidden="true" style="color:#FF6F00"> Firma Invalida(1)</i>';case"9":return'<i class="fa fa-minus-circle" aria-hidden="true" style="color:#FF6F00"> Firma Invalida(2)</i>';case"10":return'<i class="fa fa-minus-circle" aria-hidden="true" style="color:#FF6F00"> Firma Invalida(3)</i>';default:return"Desconocido"}}},{title:"ACCION",className:"buttons",data:"claveNC",render:function(data,type,row,meta){if(null!=data)return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green">&nbsp Factura Cancelada!</i>';switch(row.idEstadoComprobante){case"1":return"<button class=btnEnviarFactura>&nbsp Enviar</button>";case"2":return'<i class="fa fa-check-square-o">&nbsp Enviada</i>';case"3":return"<button class=btnCancelaFactura>&nbsp Cancelar Factura</button>";case"4":return"<button class=btnNC_CreateFact_Ref>&nbsp Cancelar & Reenviar</button>";case"5":return'<i class="fa fa-cloud-upload" aria-hidden="true">&nbsp Enviar Contingencia</i>';default:return"<button>Soporte</button>"}}}],footerCallback:function(row,data,start,end,display){var api=this.api(),intVal=function(i){return"string"==typeof i?parseFloat(i.replace(/[\¢,]/g,"")):"number"==typeof i?i:0},subTotal=display.map(el=>data[el].totalComprobante).reduce((a,b)=>intVal(a)+intVal(b),0);$(api.column(1).footer()).html("TOTALES"),$(api.column(5).footer()).html("¢"+parseFloat(Number(subTotal)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","))}})}drawFacExternas(e){var facturas=JSON.parse(e);this.tb_facturasExternas=$("#tb_facturasExternas").DataTable({responsive:!0,destroy:!0,dom:"Bfrtip",buttons:[{extend:"excelHtml5",footer:!0,exportOptions:{columns:[1,2,3,4,5,6]},messageTop:"Lista de facturas"},{extend:"pdfHtml5",footer:!0,messageTop:"Lista de facturas",exportOptions:{columns:[1,2,3,4,5,6]}}],language:{infoEmpty:"Sin Facturas Registradas",emptyTable:"Sin Facturas Registradas",search:"Buscar",zeroRecords:"No hay resultados",lengthMenu:"Mostrar _MENU_ registros",paginate:{first:"Primera",last:"Ultima",next:"Siguiente",previous:"Anterior"}},data:facturas,order:[[1,"desc"]],columns:[{title:"ID FACTURA",data:"id",visible:!1},{title:"#FACTURA",data:"consecutivo"},{title:"FECHA",data:"fechaCreacion"},{title:"ALMACEN",data:"bodega"},{title:"VENDEDOR",data:"vendedor"},{title:"TOTAL",data:"totalComprobante",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"MONTO EFECTIVO",data:"montoEfectivo",visible:!1,mRender:function(e){return null==e?"¢0":"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"MONTO TARJETA",data:"montoTarjeta",visible:!1,mRender:function(e){return null==e?"¢0":"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"ESTADO",data:"idEstadoComprobante",mRender:function(e){switch(e){case"1":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:red"> Sin Enviar</i>';case"2":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:green"> Enviado</i>';case"3":return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green"> Aceptado</i>';case"4":return'<i class="fa fa-times-circle" aria-hidden="true" style="color:red"> Rechazado</i>';case"5":return'<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color:#FF6F00"> Otro</i>';case"6":return'<i class="fa fa-stopwatch" aria-hidden="true" style="color:#FF6F00"> TimedOut</i>';case"7":return'<i class="fa fa-angle-double-up" aria-hidden="true" style="color:#FF6F00"> Repetido</i>';case"8":return'<i class="fa fa-minus-circle" aria-hidden="true" style="color:#FF6F00"> Firma Invalida(1)</i>';case"9":return'<i class="fa fa-minus-circle" aria-hidden="true" style="color:#FF6F00"> Firma Invalida(2)</i>';case"10":return'<i class="fa fa-minus-circle" aria-hidden="true" style="color:#FF6F00"> Firma Invalida(3)</i>';default:return"Desconocido"}}},{title:"ACCION",className:"buttons",data:"claveNC",render:function(data,type,row,meta){if(null!=data)return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green">&nbsp Factura Cancelada!</i>';switch(row.idEstadoComprobante){case"1":return"<button class=btnEnviarFactura>&nbsp Enviar</button>";case"2":return'<i class="fa fa-check-square-o">&nbsp Enviada</i>';case"3":return"<button class=btnCancelaFactura>&nbsp Cancelar Factura</button>";case"4":return"<button class=btnNC_CreateFact_Ref>&nbsp Cancelar & Reenviar</button>";case"5":return'<i class="fa fa-cloud-upload" aria-hidden="true">&nbsp Enviar Contingencia</i>';default:return"<button>Soporte</button>"}}}],footerCallback:function(row,data,start,end,display){var api=this.api(),intVal=function(i){return"string"==typeof i?parseFloat(i.replace(/[\¢,]/g,"")):"number"==typeof i?i:0},subTotal=display.map(el=>data[el].totalComprobante).reduce((a,b)=>intVal(a)+intVal(b),0);$(api.column(1).footer()).html("TOTALES"),$(api.column(5).footer()).html("¢"+parseFloat(Number(subTotal)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","))}})}drawFacUser(e){var facturas=JSON.parse(e);this.tb_facturas=$("#tb_facturas").DataTable({responsive:!0,destroy:!0,dom:"Bfrtip",buttons:[{extend:"excelHtml5",footer:!0,exportOptions:{columns:[1,2,3,4,5,6]},messageTop:"Lista de facturas"},{extend:"pdfHtml5",footer:!0,messageTop:"Lista de facturas",exportOptions:{columns:[1,2,3,4,5,6]}}],language:{infoEmpty:"Sin Facturas Registradas",emptyTable:"Sin Facturas Registradas",search:"Buscar",zeroRecords:"No hay resultados",lengthMenu:"Mostrar _MENU_ registros",paginate:{first:"Primera",last:"Ultima",next:"Siguiente",previous:"Anterior"}},data:facturas,order:[[1,"desc"]],columns:[{title:"ID FACTURA",data:"id",visible:!1},{title:"#FACTURA",data:"consecutivo"},{title:"FECHA",data:"fechaCreacion"},{title:"ALMACEN",data:"bodega"},{title:"VENDEDOR",data:"vendedor"},{title:"TOTAL",data:"totalComprobante",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"MONTO EFECTIVO",data:"montoEfectivo",visible:!1,mRender:function(e){return null==e?"¢0":"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"MONTO TARJETA",data:"montoTarjeta",visible:!1,mRender:function(e){return null==e?"¢0":"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"ESTADO",data:"idEstadoComprobante",mRender:function(e){switch(e){case"1":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:red"> Sin Enviar</i>';case"2":return'<i class="fa fa-paper-plane" aria-hidden="true" style="color:green"> Enviado</i>';case"3":return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green"> Aceptado</i>';case"4":return'<i class="fa fa-times-circle" aria-hidden="true" style="color:red"> Rechazado</i>';case"5":return'<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color:#FF6F00"> Otro</i>';case"99":return'<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color:green"> Reportado</i>';default:return"Desconocido"}}},{title:"ACCION",className:"buttons",data:"claveNC",render:function(data,type,row,meta){if(null!=data)return'<i class="fa fa-check-square-o" aria-hidden="true" style="color:green">&nbsp Factura Cancelada!</i>';switch(row.idEstadoComprobante){case"1":return"<button class=btnEnviarFactura>&nbsp Enviar</button>";case"2":return'<i class="fa fa-check-square-o">&nbsp Enviada</i>';case"3":return"<button class=btnCancelaFactura>&nbsp Cancelar Factura</button>";case"4":return"<button class=btnNC_CreateFact_Ref>&nbsp Cancelar & Reenviar</button>";case"5":return'<i class="fa fa-cloud-upload" aria-hidden="true">&nbsp Enviar Contingencia</i>';default:return"<button>Soporte</button>"}}}],footerCallback:function(row,data,start,end,display){var api=this.api(),intVal=function(i){return"string"==typeof i?parseFloat(i.replace(/[\¢,]/g,"")):"number"==typeof i?i:0},subTotal=display.map(el=>data[el].totalComprobante).reduce((a,b)=>intVal(a)+intVal(b),0);$(api.column(1).footer()).html("TOTALES"),$(api.column(5).footer()).html("¢"+parseFloat(Number(subTotal)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","))}})}ReadbyID(id){$("#mensajeRechazo").text(""),$("#detalleFac").empty();var detalleFac=`<button type="button" class="close" data-dismiss="modal">\n                <span aria-hidden="true">x</span>\n            </button>\n            <h4 class="modal-title">Factura #</h4>\n            <h4 class="modal-title" id="consecutivo">${id.consecutivo}.</h4>\n            <div class="row">\n                <div class="col-md-6 col-sm-6 col-xs-6">\n                    <label>Fecha:</label>\n                    <label id='fecha'>${id.fechaCreacion}</label>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-md-6 col-sm-6 col-xs-6">\n                    <label>Cajero:</label>\n                    <label id='cajero'>${id.vendedor}</label>\n                </div>\n                <div class="col-md-6 col-sm-6 col-xs-6">\n                    <label>Bodega:</label>\n                    <label id='bodega'>${id.bodega}</label>\n                </div>\n            </div>`;$("#detalleFac").append(detalleFac),$("#totalFact").empty(),$.ajax({type:"POST",url:"class/productoXFactura.php",data:{action:"ReadByIdFactura",id:id.id}}).done(function(e){inventarioFacturas.drawFactDetail(e)}),"4"==id.idEstadoComprobante&&inventarioFacturas.ReadRespuestaRachazo(id.id)}ReadRespuestaRachazo(idFactura){var resultado="",referenciaCircular=inventarioFacturas.tb_facturas;inventarioFacturas.tb_facturas=[],$.ajax({type:"POST",url:"class/Factura.php",data:{action:"ReadRespuestaRachazo",id:idFactura}}).done(function(e){inventarioFacturas.tb_facturas=referenciaCircular,resultado=JSON.parse(e),$("#mensajeRechazo").text(""),$("#mensajeRechazo").append('</br><label class="control-label">FACTURA RECHAZADA - Respuesta Ministerio de Hacienda</label></br>'),$("#mensajeRechazo").append(resultado[0].respuesta)})}CargaListaFacturasRango(){var referenciaCircular=inventarioFacturas.tb_facturas;inventarioFacturas.tb_facturas=[],$.ajax({type:"POST",url:"class/Factura.php",data:{action:"ReadAllbyRange",obj:JSON.stringify(inventarioFacturas)}}).done(function(e){" "!=e?(inventarioFacturas.tb_facturas=referenciaCircular,inventarioFacturas.drawFac(e)):swal({type:"success",title:"Listo, no hay facturas que cargar!",showConfirmButton:!1,timer:2e3})})}CargaListaFacturasRangoExternas(){var referenciaCircular=inventarioFacturas.tb_facturasExternas;inventarioFacturas.tb_facturasExternas=[],$.ajax({type:"POST",url:"class/Factura.php",data:{action:"ReadAllbyRangeExterna",obj:JSON.stringify(inventarioFacturas)}}).done(function(e){" "!=e?(inventarioFacturas.tb_facturasExternas=referenciaCircular,inventarioFacturas.drawFacExternas(e)):swal({type:"success",title:"Listo, no hay facturas que cargar!",showConfirmButton:!1,timer:2e3})})}CargaListaFacturasRangoUser(){var referenciaCircular=inventarioFacturas.tb_facturas;inventarioFacturas.tb_facturas=[],$.ajax({type:"POST",url:"class/Factura.php",data:{action:"ReadAllbyRange",obj:JSON.stringify(inventarioFacturas)}}).done(function(e){inventarioFacturas.tb_facturas=referenciaCircular,inventarioFacturas.drawFac(e)})}sendContingenciaMasiva(){$.ajax({type:"POST",url:"class/Factura.php",data:{action:"sendContingenciaMasiva"}}).done(function(e){inventarioFacturas.CargaListaFacturasRango()})}sendMasiva(){$.ajax({type:"POST",url:"class/Factura.php",data:{action:"sendMasiva"}}).done(function(e){inventarioFacturas.CargaListaFacturasRango()})}CargaMisFacturasRango(){var referenciaCircular=inventarioFacturas.tb_facturas;inventarioFacturas.tb_facturas=[],$.ajax({type:"POST",url:"class/Factura.php",data:{action:"ReadAllbyRangeUser",obj:JSON.stringify(inventarioFacturas)}}).done(function(e){" "!=e?(inventarioFacturas.tb_facturas=referenciaCircular,inventarioFacturas.drawFacUser(e)):swal({type:"success",title:"Listo, no hay facturas que cargar!",showConfirmButton:!1,timer:2e3})})}drawFactDetail(e){this.factDetalle=JSON.parse(e),this.tb_prdXFact=$("#tb_detalle_fact").DataTable({data:this.factDetalle,destroy:!0,searching:!1,paging:!1,info:!1,ordering:!1,order:[[0,"desc"]],columns:[{title:"PRODUCTO",data:"detalle"},{title:"CANTIDAD",data:"cantidad",type:"formatted-num",mRender:function(e){return parseFloat(e).toFixed(2)}},{title:"PRECIO",data:"montoTotalLinea",type:"formatted-num",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}}]}),$("#modalFac").modal("toggle")}ticketPrint(){localStorage.setItem("lsFactura",$("#consecutivo").text()),localStorage.setItem("lsBodega",$("#bodega").text()),localStorage.setItem("lsUsuario",$("#call_username").text()),localStorage.setItem("lsListaProducto",JSON.stringify(this.factDetalle)),location.href="/TicketFacturacion.html"}ticketPrintCancelada(data){localStorage.setItem("lsFactura",data.consecutivo),localStorage.setItem("lsBodega",data.bodega),localStorage.setItem("lsUsuario",$("#call_username").text()),localStorage.setItem("lsEfectivo",data.montoEfectivo),localStorage.setItem("lsVuelto",parseFloat(data.montoEfectivo)-parseFloat(data.totalComprobante)),localStorage.setItem("lsTotal",data.totalComprobante),localStorage.setItem("lsClave",data.clave),$.ajax({type:"POST",url:"class/productoXFactura.php",data:{action:"ReadByIdFactura",id:data.id}}).done(function(e){inventarioFacturas.factDetalle=JSON.parse(e),localStorage.setItem("lsListaProducto",JSON.stringify(inventarioFacturas.factDetalle)),location.href="/TicketFacturacion.html"})}}let inventarioFacturas=new InventarioFacturas;$("#tb_facturas tbody").on("click","td",function(){if("BTN"!=localStorage.getItem("lsPrintFacturaOpcion")&&("&nbsp; Factura Cancelada!"==$(this).parents("tr").find("td:eq(6) i").html()?localStorage.setItem("lsPrintFacturaOpcion","CANCEL"):localStorage.setItem("lsPrintFacturaOpcion","LIST")),"Enviar"==$.trim(this.textContent)||"Cancelar Factura"==$.trim(this.textContent)||"Cancelar & Reenviar"==$.trim(this.textContent))return!1;inventarioFacturas.ReadbyID(inventarioFacturas.tb_facturas.row(this).data());var dtTable=$("#tb_facturas").DataTable(),efectivo=0,total=0,fecha;efectivo=parseFloat(dtTable.row(this).data()[8]),total=parseFloat(dtTable.row(this).data()[11]),fecha=dtTable.row(this).data()[3],null==dtTable.cells().data()[5]&&(efectivo=0),null==dtTable.cells().data()[6]&&(tarjeta=0),"0"==efectivo?(localStorage.setItem("lsVuelto","0"),localStorage.setItem("lsTarjetaCredito",String(total))):(localStorage.setItem("lsVuelto",String(efectivo-total)),localStorage.setItem("lsTarjetaCredito","0")),localStorage.setItem("lsFecha",fecha),localStorage.setItem("lsEfectivo",String(efectivo)),localStorage.setItem("lsTotal",String(total)),localStorage.setItem("lsDif","0"),localStorage.setItem("lsReimpresion","OK")});