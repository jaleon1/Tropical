class OrdenCompra{constructor(id,orden,fecha,idProdveedor,idUsuario,lista,tablaOrdenCompra,fechaInicial,fechaFinal){this.id=id||null,this.orden=orden||"",this.fecha=fecha||"",this.idProdveedor=idProdveedor||"",this.idUsuario=idUsuario||"",this.lista=lista||[],this.tablaOrdenCompra=tablaOrdenCompra||[],this.fechaInicial=fechaInicial||"",this.fechaFinal=fechaFinal||""}get Read(){var miAccion=null==this.id?"ReadAll":"ReadbyOrden";$.ajax({type:"POST",url:"class/OrdenCompra.php",data:{action:miAccion,id:this.id}}).done(function(e){ordenCompra.Reload(e)}).fail(function(e){})}get Save(){if(""!=$("#orden").val())if(0!=$("#productos").length){$("#btnOrdenCompra").attr("disabled","disabled");var miAccion=null==this.id?"Create":"Update";this.orden=$("#orden").val(),this.idProveedor=$("#proveedor").val(),ordenCompra.lista=[],$("#productos tr").each(function(i,item){var objlista=new Object;objlista.idInsumo=$("#dsitems").dataTable().fnGetData(item)[0],objlista.esVenta=$("#dsitems").dataTable().fnGetData(item)[3],objlista.costoUnitario=$(this).find("td:eq(3) input").val(),objlista.cantidadBueno=$(this).find("td:eq(4) input").val(),objlista.cantidadMalo=$(this).find("td:eq(5) input").val(),objlista.valorBueno=$(this).find("td:eq(6) input.valor").val(),objlista.valorMalo=$(this).find("td:eq(7) input.valor").val(),ordenCompra.lista.push(objlista)}),$.ajax({type:"POST",url:"class/OrdenCompra.php",data:{action:miAccion,obj:JSON.stringify(this)}}).done(ordenCompra.showInfo).fail(function(e){ordenCompra.showError(e)}).always(function(){$("#btnOrdenCompra").removeAttr("disabled"),(ordenCompra=new OrdenCompra).CleanCtls(),$("#p_searh").focus()})}else swal({type:"warning",title:"Orden de Compra",text:"Debe agregar items a la lista",showConfirmButton:!1,timer:3e3});else swal({type:"warning",title:"Orden de Compra",text:"Debe digitar el número de factura de proveedor",showConfirmButton:!1,timer:3e3})}Reload(e){null==this.id?this.ShowAll(e):this.ShowItemData(e)}ShowAll(e){var t=$("#dsOrdenCompra").DataTable();0==t.rows().count()?(t.clear(),t.rows.add(JSON.parse(e)),t.draw(),$(document).on("click","#dsOrdenCompra tbody tr td:not(.buttons)",ordenCompra.SelectEventHandler)):(t.clear(),t.rows.add(JSON.parse(e)),t.draw())}ShowItemData(e){var t=$("#dsInsumoOrdenCompra").DataTable();t.rows().count(),t.clear(),t.rows.add(JSON.parse(e)),t.draw()}SelectEventHandler(){ordenCompra.id=$(this).parents("tr").find(".itemId").text()||$(this).find(".itemId").text();var fecha=$(this).parents("tr").find("td:eq(1)").html(),usuario=$(this).parents("tr").find("td:eq(3)").html(),orden=$(this).parents("tr").find("td:eq(2)").html();ordenCompra.setTableInsumoOrdenCompra(orden,usuario,fecha),ordenCompra.Read,$(".bs-ordenCompra-modal-lg").modal("toggle")}setTableOrdenCompra(){jQuery.extend(jQuery.fn.dataTableExt.oSort,{"formatted-num-pre":function(a){return a="-"===a||""===a?0:a.replace(/[^\d\-\.]/g,""),parseFloat(a)},"formatted-num-asc":function(a,b){return a-b},"formatted-num-desc":function(a,b){return b-a}}),this.tablaOrdenCompra=$("#dsOrdenCompra").DataTable({responsive:!0,destroy:!0,order:[1,"desc"],dom:"Bfrtip",buttons:[{extend:"excelHtml5",exportOptions:{columns:[1,2,3]},messageTop:"Reporte Orden de Compra"},{extend:"pdfHtml5",exportOptions:{columns:[1,2,3]},messageTop:"Reporte Orden de Compra",customize:function(doc){doc.defaultStyle.alignment="right",doc.styles.tableHeader.alignment="right"}}],language:{infoEmpty:"Sin Ordenes de Compra",emptyTable:"Sin Ordenes de Compra",search:"Buscar",zeroRecords:"No hay resultados",lengthMenu:"Mostrar _MENU_ registros",paginate:{first:"Primera",last:"Ultima",next:"Siguiente",previous:"Anterior"}},columns:[{title:"ID",data:"id",className:"itemId",searchable:!1},{title:"FECHA",data:"fecha"},{title:"ORDEN",data:"orden"},{title:"USUARIO",data:"usuario"},{title:"ACCION",orderable:!1,searchable:!1,mRender:function(){return'<a class="delete buttons" style="cursor: pointer;" onclick="ordenCompra.DeleteOrdenCompra(this)" > <i class="glyphicon glyphicon-trash"> </i></a>'},visible:!0}]})}setTableInsumoOrdenCompra(orden,usuario,fecha){jQuery.extend(jQuery.fn.dataTableExt.oSort,{"formatted-num-pre":function(a){return a="-"===a||""===a?0:a.replace(/[^\d\-\.]/g,""),parseFloat(a)},"formatted-num-asc":function(a,b){return a-b},"formatted-num-desc":function(a,b){return b-a}}),this.tablaOrdenCompra=$("#dsInsumoOrdenCompra").DataTable({responsive:!0,destroy:!0,order:[[3,"asc"]],dom:"Bfrtip",buttons:[{extend:"excelHtml5",footer:!0,exportOptions:{columns:[1,2,3,4,5,6,7,8]},messageTop:"FECHA:  "+fecha+"  ORDEN:  "+orden,messageBottom:"USUARIO:  "+usuario},{extend:"pdfHtml5",footer:!0,exportOptions:{columns:[1,2,3,4,5,6,7,8]},messageTop:"FECHA:  "+fecha+"  ORDEN:  "+orden,messageBottom:"USUARIO:  "+usuario}],columnDefs:[{className:"text-right",targets:[3,4,5,6,7,8]}],language:{infoEmpty:"Sin Insumos",emptyTable:"Sin Insumos",search:"Buscar",zeroRecords:"No hay resultados",lengthMenu:"Mostrar _MENU_ registros",paginate:{first:"Primera",last:"Ultima",next:"Siguiente",previous:"Anterior"}},columns:[{title:"ID",data:"id",className:"itemId",searchable:!1},{title:"CODIGO",data:"codigo",width:"auto"},{title:"INSUMO",data:"insumo",width:"auto"},{title:"COSTO UNITARIO",data:"costoUnitario",width:"auto",type:"formatted-num",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"BUENO",data:"cantidadBueno",width:"auto"},{title:"MALO",data:"cantidadMalo",width:"auto"},{title:"VALOR BUENO",data:"valorBueno",width:"auto",type:"formatted-num",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"VALOR MALO",data:"valorMalo",width:"auto",type:"formatted-num",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{title:"SUBTOTAL",data:"subtotal",width:"auto",type:"formatted-num",mRender:function(e){return"¢"+parseFloat(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}}],footerCallback:function(row,data,start,end,display){var api=this.api(),intVal=function(i){return"string"==typeof i?parseFloat(i.replace(/[\¢,]/g,"")):"number"==typeof i?i:0},totalCantidadBueno=display.map(el=>data[el][5]).reduce((a,b)=>intVal(a)+intVal(b),0),totalCantidadMalo=display.map(el=>data[el][6]).reduce((a,b)=>intVal(a)+intVal(b),0),totalBueno=display.map(el=>data[el][7]).reduce((a,b)=>intVal(a)+intVal(b),0),totalMalo=display.map(el=>data[el][8]).reduce((a,b)=>intVal(a)+intVal(b),0),subTotal=display.map(el=>data[el].subtotal).reduce((a,b)=>intVal(a)+intVal(b),0);$(api.column(1).footer()).html("TOTALES"),$(api.column(4).footer()).html(totalCantidadBueno),$(api.column(5).footer()).html(totalCantidadMalo),$(api.column(6).footer()).html("¢"+parseFloat(Number(totalBueno)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")),$(api.column(7).footer()).html("¢"+parseFloat(Number(totalMalo)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")),$(api.column(8).footer()).html("¢"+parseFloat(Number(subTotal)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","))}})}showInfo(){$(".close").click(),swal({type:"success",title:"Listo!",showConfirmButton:!1,timer:1e3})}showError(e){var data=JSON.parse(e.responseText);swal({type:"error",title:"Oops...",text:"Algo no está bien ("+data.code+"): "+data.msg,footer:"<a href>Contacte a Soporte Técnico</a>"})}LoadInsumo(){""!=$("#p_searh").val()&&(insumo.codigo=$("#p_searh").val(),$.ajax({type:"POST",url:"class/Insumo.php",data:{action:"ReadByCode",obj:JSON.stringify(insumo)}}).done(function(e){ordenCompra.ValidateInsumoFac(e)}).fail(function(e){ordenCompra.showError(e)}))}LoadArticulo(){""!=$("#p_searh").val()&&(producto.codigo=$("#p_searh").val(),$.ajax({type:"POST",url:"class/Producto.php",data:{action:"ReadArticuloByCode",obj:JSON.stringify(producto)}}).done(function(e){ordenCompra.ResetSearch(),ordenCompra.ValidateInsumoFac(e)}).fail(function(e){ordenCompra.showError(e)}))}ValidateInsumoFac(e){if("[]"!=e)if("false"!=e&&""!=e){insumo=JSON.parse(e)[0],insumo.UltPrd=insumo.codigo;var repetido=!1;0!=document.getElementById("productos").rows.length&&null!=insumo&&$(document.getElementById("productos").rows).each(function(i,item){item.childNodes[0].innerText==insumo.codigo&&(repetido=!0,swal({type:"warning",title:"Orden de Compra",text:"El item "+producto.codigo+" ya se encuentra en la lista",showConfirmButton:!1,timer:3e3}))}),0==repetido&&(ordenCompra.AgregaInsumo(),ordenCompra.ResetSearch())}else ordenCompra.LoadArticulo();else swal({type:"warning",title:"Orden de Compra",text:"El item "+insumo.codigo+" No existe.",showConfirmButton:!1,timer:3e3})}ValidateArticuloFac(e){if("false"!=e){producto=JSON.parse(e)[0],producto.UltPrd=producto.codigo;var repetido=!1;0!=document.getElementById("productos").rows.length&&null!=producto&&$(document.getElementById("productos").rows).each(function(i,item){if(item.childNodes[0].innerText==producto.codigo){item.childNodes[3].childNodes[0].attributes[3].value=producto.cantidad;var CantAct=parseInt(item.childNodes[3].firstElementChild.value);parseInt(producto.cantidad)>CantAct&&(item.childNodes[3].firstElementChild.value=parseFloat(item.childNodes[3].firstElementChild.value)+1),repetido=!0}}),0==repetido&&(ordenCompra.AgregaInsumo(),ordenCompra.ResetSearch())}else ordenCompra.ResetSearch()}CleanCtls(){$("#p_searh").val(""),$("#proveedor").val(""),$("#orden").val(""),$("#productos").html(""),t.clear()}ResetSearch(){$("#p_searh").val("")}AgregaInsumo(){var rowNode=t.row.add([insumo.id,insumo.codigo,insumo.nombre,insumo.esVenta||-1,"Precio Unitario","0","0","0","0","0"]).draw().node();$("td:eq(3) input",rowNode).attr({id:"prec_"+insumo.codigo,max:"9999999999",min:"0",step:"1",value:"1"}).change(function(){ordenCompra.CalcImporte($(this).parents("tr").find("td:eq(0)").html())}),$("td:eq(4) input",rowNode).attr({id:"cantBueno_"+insumo.codigo,max:"9999999999",min:"1",step:"1",value:"1"}).change(function(){ordenCompra.CalcImporte($(this).parents("tr").find("td:eq(0)").html())}),$("td:eq(5) input",rowNode).attr({id:"cantMalo_"+insumo.codigo,max:"9999999999",min:"0",step:"1",value:"0"}).change(function(){ordenCompra.CalcImporte($(this).parents("tr").find("td:eq(0)").html())}),$("td:eq(6) input.valor",rowNode).attr({id:"valorBueno_v"+insumo.codigo,style:"display:none"}),$("td:eq(6) input.display",rowNode).attr({id:"valorBueno_d"+insumo.codigo}),$("td:eq(7) input.valor",rowNode).attr({id:"valorMalo_v"+insumo.codigo,style:"display:none"}),$("td:eq(7) input.display",rowNode).attr({id:"valorMalo_d"+insumo.codigo}),$("td:eq(8) input.valor",rowNode).attr({id:"subtotal_v"+insumo.codigo,style:"display:none"}),$("td:eq(8) input.display",rowNode).attr({id:"subtotal_d"+insumo.codigo}),t.columns.adjust().draw(),ordenCompra.CalcImporte(insumo.codigo)}CalcImporte(prd){insumo.UltPrd=prd,insumo.precio=$(`#prec_${prd}`).val(),insumo.cantBueno=$(`#cantBueno_${prd}`).val(),insumo.cantMalo=$(`#cantMalo_${prd}`).val(),insumo.valorBueno=parseFloat(insumo.precio)*parseInt(insumo.cantBueno),insumo.valorMalo=parseFloat(insumo.precio)*parseInt(insumo.cantMalo),insumo.subTotal=insumo.valorBueno+insumo.valorMalo,$(`#valorBueno_v${prd}`).val(insumo.valorBueno.toFixed(10)),$(`#valorBueno_d${prd}`).val("¢"+insumo.valorBueno.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")),$(`#valorMalo_v${prd}`).val(insumo.valorMalo.toFixed(10)),$(`#valorMalo_d${prd}`).val("¢"+insumo.valorMalo.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")),$(`#subtotal_v${prd}`).val(insumo.subTotal.toFixed(10)),$(`#subtotal_d${prd}`).val("¢"+insumo.subTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","))}DeleteInsumoOrdenCompra(e){t.row($(e).parents("tr")).remove().draw()}DeleteOrdenCompra(e){swal({title:"Eliminar?",text:"Esta acción es irreversible!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, cancelar!",confirmButtonClass:"btn btn-success",cancelButtonClass:"btn btn-danger"}).then(result=>{result.value&&(ordenCompra.id=$(e).parents("tr").find(".itemId").text(),ordenCompra.orden=$(e).parents("tr").find("td:eq(2)").text(),$.ajax({type:"POST",url:"class/OrdenCompra.php",data:{action:"Delete",id:ordenCompra.id,orden:ordenCompra.orden}}).done(ordenCompra.showInfo).fail(function(e){ordenCompra.showError(e)}).always(function(){(ordenCompra=new OrdenCompra).CargaOrdenCompraRango()}))})}CargaOrdenCompraRango(){var referenciaCircular=ordenCompra.tablaOrdenCompra;ordenCompra.tablaOrdenCompra=[],$.ajax({type:"POST",url:"class/OrdenCompra.php",data:{action:"ReadAllbyRange",obj:JSON.stringify(ordenCompra)}}).done(function(e){ordenCompra.tablaOrdenCompra=referenciaCircular,ordenCompra.ShowAll(e)})}Init(){}}let ordenCompra=new OrdenCompra;