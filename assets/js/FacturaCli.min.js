class FacturaCli{constructor(id,totalVenta,detalleOrden,detalleFactura,medioPago,totalComprobante,montoEfectivo,montoTarjeta,estadoCaja){this.id=id||null,this.totalVenta=totalVenta||"",this.detalleFactura=detalleFactura||new Array,this.detalleOrden=detalleOrden||new Array,this.medioPago=medioPago||0,this.totalComprobante=totalComprobante||0,this.montoEfectivo=montoEfectivo||0,this.montoTarjeta=montoTarjeta||0}}let facturaCli=new FacturaCli;var t;sabores=2,toppings=1,sel_tamano=0,precioXTamano=0;var precioMediano=new Object,precioGrande=new Object;function LoadAllPrdVenta(){$.ajax({type:"POST",url:"class/Producto.php",data:{action:"ReadAllProductoVenta"}}).done(function(e){DrawPrd(e)}).fail(function(e){showError(e)})}function LoadPreciosTamanos(){$.ajax({type:"POST",url:"class/Factura.php",data:{action:"LoadPreciosTamanos"}}).done(function(e){"NOCONTRIB"==JSON.parse(e)?swal({type:"warning",title:"Contribuyente",text:"Contribuyente no registrado para Facturación Electrónica",footer:'<a href="clienteFE.html">Agregar Contribuyente</a>',allowOutsideClick:!1}).then(result=>{result.value&&(location.href="Dashboard.html")}):setPrecios(e)}).fail(function(e){showError(e)})}function setPrecios(e){precios=JSON.parse(e),$.each(precios,function(i,item){1==item.tamano?(precioGrande.precio=item.precioVenta,precioGrande.id=item.id):0==item.tamano&&(precioMediano.precio=item.precioVenta,precioMediano.id=item.id)})}function DrawPrd(e){productos=JSON.parse(e),$.each(productos,function(item,value){switch(productos[item].esVenta){case"1":DrawSabor(productos[item]);break;case"2":DrawTopping(productos[item])}})}function DrawSabor(sabores){var prd=`\n    <button id="${sabores.id}" class="btn_sabor btn_venta" style="background-color:${sabores.bgColor};" onclick="agregaSabor('${sabores.id}', '${sabores.nombre}')">\n        <div class="btn_prd" style="color:${sabores.txtColor}";>\n            <h5 hidden>${sabores.nombreAbreviado}</h5>\n            <h5>${sabores.nombre}</h5>\n            <p id="cant_sabor_${sabores.id}"></p>\n        </div>\n    </button>`;$("#prdXbdg").append(prd)}function DrawTopping(toppings){var prd=`\n        <button id="${toppings.id}" style="background-color:${toppings.bgColor};" class="btn_topping btn_venta" onclick="agrega_toppings('${toppings.id}', '${toppings.nombre}')">\n            <div style="color: ${toppings.txtColor};">\n                <h5 hidden>${toppings.nombreAbreviado}</h5>\n                <h5>${toppings.nombre}</h5>\n                <p id="cant_topping_${toppings.id}"> </p>\n            </div>\n        </button>`;$("#toppings").append(prd)}function verificaCantidad(tipo){switch(tipo){case"sabor":if(sabores>0)return sabores-=1,!0;break;case"topping":if(toppings>0)return toppings-=1,!0;break;default:return!1}}function agregaSabor(id,nombre){if(verificaCantidad("sabor")){"1"!=$("#cant_sabor_"+id).text()&&"2"!=$("#cant_sabor_"+id).text()?$("#cant_sabor_"+id).text("1"):$("#cant_sabor_"+id).text(parseInt($("#cant_sabor_"+id)[0].textContent)+1),$("#"+id).addClass("selected");var prd=`<strong id="eleccion_${id}" class="saborelegido" onclick="quitaSabor('${id}')">\n            ${nombre} \n            <spam class="glyphicon glyphicon-remove"</spam>  \n        </strong>`;$("#sabores_elegidos").append(prd),$("#sabores_elegidos"+id).addClass("selected")}btnAgregaPRD()}function quitaSabor(id){"2"==$("#cant_sabor_"+id).text()?$("#cant_sabor_"+id).text("1"):($("#"+id).removeClass("selected"),$("#cant_sabor_"+id).text(" ")),sabores+=1,$("#eleccion_"+id).remove(),btnAgregaPRD()}function agrega_toppings(id_topping,nombre_topping){if(verificaCantidad("topping")){"1"!=$("#cant_topping_"+id_topping).text()&&"2"!=$("#cant_topping_"+id_topping).text()?$("#cant_topping_"+id_topping).text("1"):$("#cant_topping_"+id_topping).text(parseInt($("#cant_topping_"+id_topping).text())+1),$("#"+id_topping).addClass("selected");var prd=`<strong id="eleccion_${id_topping}" class="saborelegido" onclick="quitaTopping('${id_topping}')">\n            ${nombre_topping} \n            <spam class="glyphicon glyphicon-remove"</spam>  \n        </strong>`;$("#toppings_elegidos").append(prd),$("#toppings_elegidos"+id_topping).addClass("selected")}btnAgregaPRD()}function quitaTopping(id){"2"==$("#cant_topping_"+id).text()?$("#cant_topping_"+id).text("1"):($("#"+id).removeClass("selected"),$("#cant_topping_"+id).text(" ")),toppings+=1,$("#eleccion_"+id).remove(),btnAgregaPRD()}function codigoTamano(){switch(sel_tamano){case 0:return"08oz";case 1:return"12oz";default:return!1}}function borraPRD(row_prd){$(row_prd).addClass("borrar"),t.row(".borrar").remove().draw(!1),calcTotal(),btnAgregaPRD(),btnFacturar()}function resetDash(){$("#toppings_elegidos").empty(),$("#sabores_elegidos").empty(),$("#prdXbdg").find(".selected").removeClass("selected"),$("#prdXbdg").find("p").text(" "),$("#toppings").find(".selected").removeClass("selected"),$("#toppings").find("p").text(" "),sabores=2,toppings=1}function calcTotal(){total=0,0!=t.columns().data()[1].length?($(t.columns().data()[0]).each(function(i,item){1==item?total+=parseFloat(precioGrande.precio):0==item&&(total+=parseFloat(precioMediano.precio)),$("#total").html("¢"+total)}),$("#total").html("¢"+total)):$("#total")[0].textContent="¢0"}function btnFacturar(){t.row().count()>0?$("#btnFacturar").removeAttr("disabled"):$("#btnFacturar").attr("disabled","disabled")}function btnAgregaPRD(){$("#prdXbdg").find(".selected").length>0&&($("#prdXbdg").find(".selected").length>=2||"2"==$("#prdXbdg").find(".selected")[0].children[0].childNodes[5].textContent)&&$("#toppings").find(".selected").length>=1?$("#btn_agrega_prd").removeAttr("disabled"):$("#btn_agrega_prd").attr("disabled","disabled")}function facCash(){facturaCli.idMedioPago=1,$("#formapago").empty(),pagar=$("#total")[0].textContent;var DivCash=`<div class="col-md-12">\n        <div class="row">\n            <div class="col-md-12 col-md-offset-4">\n                <h1 id="total_pagar">Total a Pagar: ${pagar}</h1>\n            </div>\n        </div>\n        <div class="row">\n            <div class="col-md-12">\n                <div class="col-md-4 col-md-offset-2">\n                       \n                    <div class="row">\n                        <h3 class="text-left">Paga con:</h3>\n                    </div>\n    \n                    <div class="row">\n                        <input id="txt_pagoCash" class="input-lg valPago input_pago" type="number" placeholder="Ingrese Monto en Efectivo"\n                            required="" minlength="5" autofocus="">\n                    </div>\n                    <div class="row">\n                        <br>\n                    </div>\n                    <div class="row">\n                        <h3 class="text-left" id="vuelto">Su vuelto:</h3>\n                    </div>\n                </div>\n    \n                <div class="col-md-5 col-md-offset-1">\n                <ul id="keyboard">\n                    <li class="letter" onclick="sendVal('1')">1</li>\n                    <li class="letter" onclick="sendVal('2')">2</li>\n                    <li class="letter" onclick="sendVal('3')">3</li>\n                    <li class="letter clearl" onclick="sendVal('4')">4</li>\n                    <li class="letter" onclick="sendVal('5')">5</li>\n                    <li class="letter" onclick="sendVal('6')">6</li>\n\n                    <li class="letter clearl" onclick="sendVal('7')">7</li>\n                    <li class="letter" onclick="sendVal('8')">8</li>\n                    <li class="letter" onclick="sendVal('9')">9</li>\n                    <li class="letter clearl glyphicon glyphicon-arrow-left red" onclick="sendVal('left')"></li>\n                    <li class="letter" onclick="sendVal('0')">0</li>\n                    <li class="Nosend glyphicon glyphicon-ok" id="send" onclick="sendVal('enter')"></li>\n                </ul>\n            </div>\n            </div>\n        </div>\n    </div> `;$("#formapago").append(DivCash),$("#btn-formapago").empty();var DivCash='<button type="button" id="modalFormaPago" onclick="btnFormaPago()"class="btn btn-primary">Atras</button>';$("#btn-formapago").append(DivCash)}function facCard(){facturaCli.idMedioPago=2,$("#formapago").empty(),pagar=$("#total")[0].textContent;var DivCard=`<div class="col-md-12">\n        <div class="row">\n            <div class="col-md-12 col-md-offset-4">\n                <h1 id="total_pagar">Total a Pagar: ${pagar}</h1>\n            </div>\n        </div>\n        <div class="row">\n            <div class="col-md-12">\n                <div class="col-md-4 col-md-offset-2">\n                    \n                    <div class="row">\n                        <h3 class="text-left">Ingrese Ref.:</h3>\n                    </div>\n\n                    <div class="row">\n                        <input id="txt_pagoCard" class="input-lg valRef input_pago" type="text" placeholder="Ingrese referencia"\n                            required="" minlength="5" autofocus="">\n                    </div>\n                    <div class="row">\n                        <br>\n                    </div>\n                </div>\n\n                <div class="col-md-5 col-md-offset-1">\n                    <ul id="keyboard">\n                        <li class="letter" onclick="sendRef('1')">1</li>\n                        <li class="letter" onclick="sendRef('2')">2</li>\n                        <li class="letter" onclick="sendRef('3')">3</li>\n                        <li class="letter clearl" onclick="sendRef('4')">4</li>\n                        <li class="letter" onclick="sendRef('5')">5</li>\n                        <li class="letter" onclick="sendRef('6')">6</li>\n    \n                        <li class="letter clearl" onclick="sendRef('7')">7</li>\n                        <li class="letter" onclick="sendRef('8')">8</li>\n                        <li class="letter" onclick="sendRef('9')">9</li>\n                        <li class="letter clearl glyphicon glyphicon-arrow-left red" onclick="sendRef('left')"></li>\n                        <li class="letter" onclick="sendRef('0')">0</li>\n                        <li class="Nosend glyphicon glyphicon-ok" id="send" onclick="sendRef('enter')"></li>\n                    </ul>\n                </div>\n                </div>\n        </div>\n    </div> `;$("#formapago").append(DivCard),$("#btn-formapago").empty();var DivCash='<button type="button" id="modalFormaPago" onclick="btnFormaPago()"class="btn btn-primary">Atras</button>';$("#btn-formapago").append(DivCash)}function btnFormaPago(){$("#formapago").empty();var DivCash='<div class="col-md-2"></div>\n    <div class="col-md-3" onclick="facCard()">\n        <img id="fac-ccard" src="images/credit-cards.png" class="modal-img-pago">\n        <p class="text-center">Tarjeta Crédito/Debito</p>\n    </div>\n    <div class="col-md-2"></div>\n    <div class="col-md-3" onclick="facCash()">\n        <img id="fac-cash" src="images/cash.png" class="modal-img-pago">\n        <p class="text-center">Efectivo</p>\n    </div>';$("#formapago").append(DivCash),$("#btn-formapago").empty();var DivCash='<button type="button" id="modalPago" class="btn btn-primary" data-dismiss="modal">Atras</button>';$("#btn-formapago").append(DivCash)}function CreateFact(){$(t.columns().data()[0]).each(function(ic,c){factura.producto[ic]=$(t.rows().data()[ic])});var miAccion=null==this.id?"Create":"Update";$.ajax({type:"POST",url:"class/Factura.php",data:{action:miAccion,obj:JSON.stringify(factura)}}).done(function(e){ticketPrint(e)}).fail(function(e){producto.showError(e)}).always(function(){$("#btnProducto").removeAttr("disabled"),producto=new Producto,producto.ClearCtls(),producto.Read,$("#nombre").focus()})}function ValidateProductFac(e){if("false"!=e){producto=JSON.parse(e)[0],producto.UltPrd=producto.codigoRapido;var repetido=!1;0!=document.getElementById("productos").rows.length&&null!=producto&&$(document.getElementById("productos").rows).each(function(i,item){if(item.childNodes[0].innerText==producto.codigoRapido){item.childNodes[3].childNodes[0].attributes[3].value=producto.cantidad;var CantAct=parseInt(item.childNodes[3].firstElementChild.value);parseInt(producto.cantidad)>CantAct?(item.childNodes[3].firstElementChild.value=parseFloat(item.childNodes[3].firstElementChild.value)+1,item.childNodes[4].firstChild.textContent="¢"+parseFloat(item.childNodes[2].firstChild.textContent.replace("¢",""))*parseFloat(item.childNodes[3].firstElementChild.value),calcTotal()):(alertSwal(producto.cantidad),$("#cant_"+producto.UltPrd).val(producto.cantidad)),repetido=!0,calcTotal()}}),0==repetido&&AgregaPrd()}else CleanCtls()}function AgregaPrd(){producto.UltPro=producto.codigoRapido;var rowNode=t.row.add([producto.id,producto.codigoRapido,producto.descripcion,"¢"+producto.precio,"1","¢"+producto.precio]).draw().node();$("td:eq(2)",rowNode).attr({id:"prec_"+producto.codigoRapido}),$("td:eq(4)",rowNode).attr({id:"impo_"+producto.codigoRapido}),$("td:eq(3) input",rowNode).attr({id:"cant_"+producto.codigoRapido,max:producto.cantidad,min:"0",step:"1",value:"1",onchage:"CalcImporte("+producto.codigoRapido+")"}),$("td:eq(3) input",rowNode).change(function(){CalcImporte(producto.codigoRapido)}),t.order([0,"desc"]).draw(),t.columns.adjust().draw(),calcTotal(),$("#open_modal_fac").attr("disabled",!1)}function CalcImporte(prd){producto.UltPrd=prd,pUnit=$(`#prec_${prd}`)[0].textContent.replace("¢",""),cant=parseInt($(`#cant_${prd}`)[0].value),cant<=parseInt($(`#cant_${prd}`)[0].attributes[3].value)?$(`#impo_${prd}`)[0].textContent="¢"+(parseFloat(pUnit)*parseFloat(cant)).toString():(alertSwal(producto.cantidad),$("#cant_"+producto.UltPrd).val($(`#cant_${prd}`)[0].attributes[3].value)),$(`#impo_${prd}`)[0].textContent="¢"+(parseFloat(pUnit)*parseInt($(`#cant_${prd}`)[0].value)).toString(),$(`#cant_${prd}`).keyup(function(e){13==e.which&&(0==cant&&(BorraRow(prd),calcTotal()),$(`#impo_${prd}`)[0].textContent="¢"+(parseFloat(pUnit)*parseInt($(`#cant_${prd}`)[0].value)).toString(),calcTotal(),$("#p_searh").focus())}),0==cant&&(BorraRow(prd),calcTotal(),$("#p_searh").focus())}function BorraRow(prd){$(`#prec_${prd}`)[0].parentElement.attributes[1].value=$(`#prec_${prd}`)[0].parentElement.attributes[1].value+" selected",t.row(".selected").remove().draw(!1)}function valPago(val){xPagar=parseFloat($("#total")[0].textContent.replace("¢","")),pago=parseFloat($(".valPago").val()),isNaN($(".valPago").val())?(val=val.replace(/[^0-9]/g,""),$(".valPago").val(val)):pago>=xPagar?($(".procesarFac").prop("disabled",!1),calcVuelto(pago,xPagar)):$(".procesarFac").prop("disabled",!0)}function alertSwal(cant){swal({type:"info",title:"Oops...",text:"Cantidad Inexistente de Producto!",footer:"<h3>Cantidad maxima de producto disponble es: "+cant+"</h3>",timer:3500})}function alertFact(){swal({type:"success",text:"Factura Lista!",timer:2e3}),$(".procesarFac").prop("disabled",!0),setTimeout(function(){location.reload()},2e3)}function ticketPrint(e){var data=JSON.parse(e);localStorage.setItem("lsPrintFacturaOpcion","FACT"),localStorage.setItem("lsReimpresion","NOT"),localStorage.setItem("lsFactura",data.consecutivo),localStorage.setItem("lsFecha",data.fechaCreacion),localStorage.setItem("lsBodega",$(".call_Bodega").html()),localStorage.setItem("lsUsuario",$("#call_username").text()),localStorage.setItem("lsSubTotal",data.totalComprobante),localStorage.setItem("lsTotal",data.totalComprobante),localStorage.setItem("lsClave",data.clave),localStorage.setItem("lsListaProducto",JSON.stringify(data.detalleFactura)),location.href="/Tropical/TicketFacturacion.html"}function calcVuelto(pago,xPagar){vuelto=(pago-xPagar).toFixed(2).toString(),$("#vuelto")[0].textContent="Su cambio: "+vuelto}function showError(e){var data=JSON.parse(e.responseText);alert("ERROR")}function CleanCtls(){$("#p_searh").val("")}precioGrande.precio=0,precioMediano.precio=0,$(document).ready(function(){window.onbeforeunload=function(){$("input[type=button], input[type=submit]").attr("disabled","disabled")},movimientosCaja.getStatusCashRegister(),$("#open_modal_fac").attr("disabled",!0),$("#btn_limpia").click(function(){location.reload()}),sel_tamano=1,LoadAllPrdVenta(),LoadPreciosTamanos(),t=$("#prd").DataTable({paging:!1,ordering:!1,responsive:!0,info:!1,searching:!1,scrollX:!1,scrollY:!1,scrollCollapse:!0,language:{infoEmpty:"Seleccione el sabor",emptyTable:"Seleccione el sabor",search:"Buscar En Factura"},columnDefs:[{title:"idTamaño",visible:!1,targets:0,searchable:!1},{title:"Tamaño",targets:1,width:"auto"},{title:"idSabor01",visible:!1,targets:2,searchable:!1},{title:"Sabor",width:"auto",targets:3},{title:"idSabor02",visible:!1,targets:4,searchable:!1},{title:"Sabor",width:"auto",targets:5},{title:"idTopping",visible:!1,targets:6,searchable:!1},{title:"Topping",width:"auto",targets:7}]}),$("#prd").on("click","tr",function(){prd_row=this,borraPRD(prd_row)}),$("#btn_agrega_prd").attr("disabled","disabled"),$("#btnFacturar").attr("disabled","disabled"),$("#btnFacturar").click(function(){var modalContent='<div class="modal-dialog modal-lg">\n        <div class="modal-content modal-factura">\n            <div class="modal-header">\n                <h4 class="modal-title" id="myModalLabel">Facturar</h4>\n            </div>\n            <div class="modal-body">\n                <div class="row">\n                    <div id="formapago">\n                        ok\n                    </div>\n                </div>\n            </div>\n            <div class="modal-footer">\n                <div id="btn-formapago">\n\n                </div>\n            </div>\n        </div>';$(".factura-modal-lg").html(modalContent),btnFormaPago(),$(".factura-modal-lg").modal("show"),$("#total_pagar").empty(),$("#total_pagar").append("Total a Pagar: "+$("#total")[0].textContent)})}),$("#btngrande").click(function(){$("#btngrande").addClass("selected"),$("#btnmediano").removeClass("selected"),sel_tamano=1}),$("#btnmediano").click(function(){$("#btnmediano").addClass("selected"),$("#btngrande").removeClass("selected"),sel_tamano=0}),$("#btn_agrega_prd").click(function(){idSabor=new Array,nombresabor=new Array,id_topping="",nombre_topping="",$("#prdXbdg").find(".selected").each(function(i,item){idSabor[i]=item.id,nombresabor[i]=item.children[0].childNodes[1].textContent,($("#prdXbdg").find(".selected").length=1)&&(nombresabor[1]=nombresabor[i],idSabor[1]=idSabor[i])}),$("#toppings").find(".selected").each(function(i,item){id_topping=item.id,nombre_topping=item.children[0].childNodes[1].textContent});var rowNode=t.row.add([sel_tamano,codigoTamano(),idSabor[0],nombresabor[0],idSabor[1],nombresabor[1],id_topping,nombre_topping]).draw().node();t.columns.adjust().draw(),calcTotal(),resetDash(),btnAgregaPRD(),btnFacturar()});